<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Hector Rosas, © 2025 crisanexperiencianatura. All rights reserved.">
    <link rel="stylesheet" href="./../public/css/natura.css">
    <title>crisanexperiencianatura</title>

    <!-- Favicon natura.png) -->
    <link rel="icon" href="/resources/natura.png" type="image/jpeg">

    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
    <header class="natura-header" role="banner">
        <div class="natura-logo">
            <img src="/resources/Natura.jpg" alt="Natura logo">
        </div>

        <nav class="natura-nav" role="navigation" aria-label="Principal">
            <ul>
                <li><a data-bs-toggle="offcanvas" href="#Cliente" role="button" aria-controls="offcanvasCliente">
                        Clientes
                    </a>
                </li>
                <li><a data-bs-toggle="offcanvas" href="#Pedido" role="button" aria-controls="offcanvasPedidos">
                        Pedidos
                    </a>
                </li>
                <li>
                    <a id="Ventas" role="button" aria-controls="offcanvasVentas" onclick="myFunction()">
                        Ventas
                    </a>
                </li>
            </ul>
        </nav>
        <div class="header-actions">
            <input type="search" class="search-form" id="searchInput" placeholder="producto...">
            <button type="submit" class="search-btn" id="searchBtn">Buscar</button>
        </div>
        <div id="searchAlert"></div>
    </header>
    <div>
        <%- include('clientes_grid') %>
    </div>


    <div class="offcanvas offcanvas-start" tabindex="-1" id="Cliente" aria-labelledby="offcanvasLabel"
        data-bs-backdrop="static">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasLabel">Nuevo Cliente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div>
                <%- include('cliente') %>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-start" data-bs-backdrop="static" tabindex="-1" id="Pedido"
        aria-labelledby="offcanvasLabel" style="width: 100vh;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasLabel">Añadir Pedido</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div>
                <%- include('pedido') %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script>
        function myFunction() {
            const modalId = 'graphModal';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = modalId;
            modal.style.position = 'fixed';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.backdropFilter = 'blur(4px)';

            modal.innerHTML = `
        <div style="background:#fff; border-radius:8px; width:1900px; max-width:95%; max-height:95%; overflow:hidden; display:flex; flex-direction:column;">
            <div style="padding:10px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div>
                    <label for="yearSelect"><strong>Filtrar por año:</strong></label>
                    <select id="yearSelect" style="padding:5px 10px; border-radius:4px; margin-left:8px;"></select>
                </div>
                <button id="closeClienteDetails" class="cancel-btn">Cerrar</button>
            </div>
                                
            <div style="display: flex;" overflow:auto;>
                <div style="flex: 1; margin-right: 5px;">
                    <canvas id="clienteChart" width="40" height="20"></canvas>
                </div>
                <div style="flex: 1;">
                    <canvas id="productoChart"></canvas>
                </div>
            </div>
            <div style="display: flex; overflow:auto;">
                <div style="flex; margin-left: 25px;">
                    <canvas id="ventasChart" width="360" height="380"></canvas>
                </div>
            </div>
        </div>
    `;
            document.body.appendChild(modal);
            document.getElementById('myGrid').style.display = 'none';

            const closeModal = () => {
                document.getElementById('myGrid').style.display = 'block';
                modal.remove()
            };
            modal.querySelector('#closeClienteDetails').addEventListener('click', closeModal);
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

            // --- CHART INITIALIZATION ---
            const ctxC = document.getElementById("clienteChart").getContext("2d");
            const ctxP = document.getElementById("productoChart").getContext("2d");
            const ctxV = document.getElementById("ventasChart").getContext("2d");

            const clientChart = new Chart(ctxC, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: "", data: [] }] },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        title: { display: true, text: 'Total $ por Cliente (Top 12)' },
                        legend: { display: false }
                    }
                }
            });

            const productoChart = new Chart(ctxP, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: "", data: [] }] },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        title: { display: true, text: 'Total $ por Producto (Top 10)' },
                        legend: { display: false }
                    }
                }
            });

            const ventasChart = new Chart(ctxV, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ label: "", data: [] }] },
                options: {
                    plugins: {
                        title: { display: true, text: 'Total de Ventas por Año' },
                        legend: { display: false }
                    }
                }
            });

            // --- DATA FETCH + DROPDOWN POPULATION ---
            let allPedidos = [];

            fetch('/pedidos')
                .then(response => response.json())
                .then(data => {
                    allPedidos = Array.isArray(data) ? data : (data.pedidos ?? []);
                    const mostRecentYear = populateYearDropdown(allPedidos);
                    updateCharts(mostRecentYear); // Load most recent year initially
                })
                .catch(error => console.error('Error fetching pedidos data:', error));

            // --- Populate dropdown with years ---
            function populateYearDropdown(pedidos) {
                const select = document.getElementById("yearSelect");
                const years = new Set();

                pedidos.forEach(p => {
                    const fecha = p.createdAt;
                    if (fecha) {
                        const year = new Date(fecha).getFullYear();
                        if (!isNaN(year)) years.add(year);
                    }
                });

                const sortedYears = Array.from(years).sort((a, b) => b - a);
                const mostRecentYear = sortedYears[0];

                select.innerHTML = `<option value="All">Todos</option>` +
                    sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');

                // Set default to the most recent year
                select.value = mostRecentYear;

                select.addEventListener('change', () => updateCharts(select.value));
                return mostRecentYear;
            }

            // --- Function to refresh charts based on selected year ---
            function updateCharts(selectedYear = "All") {
                const pedidos = selectedYear === "All"
                    ? allPedidos
                    : allPedidos.filter(p => {
                        const fecha = p.createdAt;
                        const year = fecha ? new Date(fecha).getFullYear() : null;
                        return year == selectedYear;
                    });

                const totalsByCliente = new Map();
                const totalsByProducts = new Map();
                const totalsByYear = new Map();

                pedidos.forEach(p => {
                    const total = parseFloat(p.total) || 0;

                    // Cliente
                    let cliente = p.cliente ?? p.clienteName ?? (p.cliente_obj && (p.cliente_obj.nombre || p.cliente_obj.name)) ?? 'Desconocido';
                    if (typeof cliente === 'object') cliente = cliente.nombre || cliente.name || JSON.stringify(cliente);
                    totalsByCliente.set(cliente, (totalsByCliente.get(cliente) || 0) + total);

                    // Producto
                    let producto = p.producto ?? p.productoName ?? (p.producto && (p.producto.nombre || p.producto.name)) ?? 'Desconocido';
                    if (typeof producto === 'object') producto = producto.nombre || producto.name || JSON.stringify(producto);
                    totalsByProducts.set(producto, (totalsByProducts.get(producto) || 0) + total);

                    // Año
                    const fecha = p.createdAt;
                    const year = fecha ? new Date(fecha).getFullYear() : 'Desconocido';
                    totalsByYear.set(year, (totalsByYear.get(year) || 0) + total);
                });

                // Update Cliente chart
                const clientes = Array.from(totalsByCliente.entries()).sort((a, b) => b[1] - a[1]);
                clientChart.data.labels = clientes.slice(0, 12).map(i => i[0]);
                clientChart.data.datasets[0].data = clientes.slice(0, 12).map(i => i[1]);
                clientChart.data.datasets[0].backgroundColor = clientes.map((_, i) => `hsl(${i * 40 % 360},70%,55%)`);
                clientChart.update();

                // Update Producto chart
                const productos = Array.from(totalsByProducts.entries()).sort((a, b) => b[1] - a[1]);
                productoChart.data.labels = productos.slice(0, 10).map(i => i[0]);
                productoChart.data.datasets[0].data = productos.slice(0, 10).map(i => i[1]);
                productoChart.data.datasets[0].backgroundColor = productos.map((_, i) => `hsl(${i * 40 % 360},70%,55%)`);
                productoChart.update();

                // Update Ventas chart
                // --- Show or hide Ventas chart depending on selection ---
                const ventasContainer = document.getElementById('ventasChart').parentElement;

                if (selectedYear === "All") {
                    // Only show doughnut when 'All' is selected
                    ventasContainer.style.display = 'block';
                    const years = Array.from(totalsByYear.entries()).sort((a, b) => b[0] - a[0]);
                    ventasChart.data.labels = years.map(i => i[0]);
                    ventasChart.data.datasets[0].data = years.map(i => i[1]);
                    ventasChart.data.datasets[0].backgroundColor = years.map((_, i) => `hsl(${i * 60 % 360},70%,60%)`);
                    ventasChart.update();
                } else {
                    ventasContainer.style.display = 'none';
                }
            }
        }
    </script>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchAlert = document.getElementById('searchAlert');
        let gridApiP;

        function showSearchAlert(type, msg) {
            searchAlert.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${msg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            setTimeout(() => { searchAlert.innerHTML = ''; }, 3500);
        }

        function createOrUpdateGrid(rows) {

            // open a new modal with an embedded AG Grid showing detailed rows (from test.ejs endpoint)
            const modalId = 'searchModal';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = modalId;
            modal.style.position = 'fixed';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.backdropFilter = 'blur(4px)';

            modal.innerHTML = `
              <div style="background:#fff; border-radius:8px; width:900px; max-width:95%; max-height:90%; overflow:hidden; display:flex; flex-direction:column;">
                <div style="padding:10px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                  <button id="closeSearchDetails" class= cancel-btn style="align:right;">Cerrar</button>
                </div>
                                    
                <div style="padding:12px; flex:1 1 auto; overflow:auto;">
                  <div id="searchdGrid" class="ag-theme-alpine" style="height:420px; width:100%;"></div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('myGrid').style.display = 'none';

            const closeModal = () => {
                document.getElementById('myGrid').style.display = 'block';
                modal.remove()
            };

            modal.querySelector('#closeSearchDetails').addEventListener('click', closeModal);
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

            const dateformatter = (params) => {
                if (params.value === null || params.value === undefined) {
                    return '';
                }
                const date = new Date(params.value);
                return date.toLocaleDateString('es-MX');
            };

            // build columnDefs from keys of first row
            const childColumnDefs = [
                { field: "cliente", filter: true, filterParams: { buttons: ['reset'] }, width: 300 },
                { field: "producto", width: 250 },
                { field: "createdAt", headerName: "Ultima Compra", sortable: true, sort: 'desc', width: 150, valueFormatter: dateformatter },
            ];

            const childGridOptions = {
                columnDefs: childColumnDefs,
                theme: agGrid.themeBalham.withPart(agGrid.colorSchemeLightCold),
                pagination: true,
                rowSelection: { mode: 'singleRow', checkboxes: false },
            }

            // create grid
            const childGridDiv = modal.querySelector('#searchdGrid');
            const childGridApi = agGrid.createGrid(childGridDiv, childGridOptions);
            childGridApi.setGridOption("rowData", rows);
        }

        async function performSearch(query) {
            if (!query) {
                showSearchAlert('warning', 'Ingrese término de búsqueda.');
                return;
            }

            try {
                const res = await fetch('/buscar/' + encodeURIComponent(query));
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || err.message || 'Error en búsqueda');
                }
                const data = await res.json();
                createOrUpdateGrid(data);
            } catch (err) {
                showSearchAlert('danger', err.message || 'Error de red');
            }
        }
        // wire events
        searchBtn.addEventListener('click', () => performSearch(searchInput.value.trim()));
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch(searchInput.value.trim());
            }
        });

    </script>

    <!-- Bootstrap JS CDN (optional, for components requiring JS) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
        integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
        crossorigin="anonymous"></script>
</body>

</html>
